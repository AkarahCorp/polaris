package dev.akarah.polaris.commands;

import com.mojang.brigadier.CommandDispatcher;
import com.mojang.brigadier.arguments.DoubleArgumentType;
import com.mojang.brigadier.arguments.IntegerArgumentType;
import com.mojang.brigadier.arguments.StringArgumentType;
import com.mojang.brigadier.builder.LiteralArgumentBuilder;
import com.mojang.datafixers.util.Pair;
import dev.akarah.polaris.Main;
import dev.akarah.polaris.io.ExceptionPrinter;
import dev.akarah.polaris.registry.Resources;
import dev.akarah.polaris.script.exception.SpannedException;
import dev.akarah.polaris.script.value.RNullable;
import dev.akarah.polaris.script.value.RNumber;
import dev.akarah.polaris.script.value.RString;
import dev.akarah.polaris.script.value.mc.REntity;
import dev.akarah.polaris.script.value.mc.RItem;
import net.fabricmc.fabric.api.command.v2.CommandRegistrationCallback;
import net.minecraft.commands.CommandSourceStack;
import net.minecraft.commands.Commands;
import net.minecraft.network.chat.Component;
import net.minecraft.server.level.ServerPlayer;
import net.minecraft.world.entity.EquipmentSlot;
import net.minecraft.world.entity.player.Player;

import java.lang.invoke.WrongMethodTypeException;
import java.util.List;
import java.util.function.BiConsumer;

public class CommandEventHandler {

    public static List<BiConsumer<CommandDispatcher<CommandSourceStack>, LiteralArgumentBuilder<CommandSourceStack>>> COMMAND_SOURCES = List.of(
            CommandEventHandler::registerCustomCommands,
            CommandEventHandler::giveCommand,
            CommandEventHandler::setTagCommand,
            CommandEventHandler::myStatsCommand,
            CommandEventHandler::summonCommand,
            CommandEventHandler::runCommand
    );

    public static void registerCustomCommands(CommandDispatcher<CommandSourceStack> dispatcher, LiteralArgumentBuilder<CommandSourceStack> root) {
        Resources.command().registry().listElements().forEach(element -> {
            var baseId = element.key().location().getPath();

            var root2 = Commands.literal(baseId);
            element.value().dispatch(root2);

            dispatcher.register(root2);
        });
    }

    public static void giveCommand(CommandDispatcher<CommandSourceStack> dispatcher, LiteralArgumentBuilder<CommandSourceStack> root) {
        root.then(Commands.literal("give"));

        Resources.customItem().registry().listElements().forEach(element -> {
            root.then(Commands.literal("give").then(Commands.literal(element.key().location().toString()).executes(ctx -> {
                try {
                    if(ctx.getSource().getEntity() instanceof Player p) {
                        p.addItem(element.value().toItemStack(RNullable.of(REntity.of(p))));
                    }
                } catch (Exception e) {
                    ExceptionPrinter.writeException(ctx.getSource().getPlayer(), e);
                }
                return 0;
            })));
            root.then(Commands.literal("give").then(Commands.literal(element.key().location().toString()).then(
                    Commands.argument("count", IntegerArgumentType.integer()).executes(ctx -> {
                        try {
                            if(ctx.getSource().getEntity() instanceof Player p) {
                                var is = element.value().toItemStack(RNullable.of(REntity.of(p)));
                                is.setCount(ctx.getArgument("count", Integer.class));
                                p.addItem(is);
                            }
                        } catch (Exception e) {
                            ExceptionPrinter.writeException(ctx.getSource().getPlayerOrException(), e);
                        }
                        return 0;
                    })
            )));
        });
    }

    public static void summonCommand(CommandDispatcher<CommandSourceStack> dispatcher, LiteralArgumentBuilder<CommandSourceStack> root) {
        Resources.customEntity().registry().listElements().forEach(element -> {
            root.then(Commands.literal("summon").then(Commands.literal(element.key().location().toString())
                    .executes(ctx -> {
                        try {
                            if(ctx.getSource().getEntity() instanceof Player p) {
                                element.value().spawn(p.level(), p.getPosition(0.0f));
                            }
                        } catch (RuntimeException exception) {
                            exception.printStackTrace();
                        }
                        return 0;
                    })));
        });
    }

    public static void runCommand(CommandDispatcher<CommandSourceStack> dispatcher, LiteralArgumentBuilder<CommandSourceStack> root) {
        var elements = Resources.actionManager().expressions()
                .entrySet()
                .stream()
                .map(x -> Pair.of(x.getKey(), x.getValue()))
                .toList();
        try {
            try {
                var methodHandle = Resources.actionManager().methodHandleByRawName("$static_init");
                methodHandle.invoke();
                elements.forEach(element -> {
                    try {
                        var method = Resources.actionManager().methodHandleByLocation(element.getFirst());
                        if(method.type().parameterCount() != 1 && method.type().parameterType(0).equals(REntity.class)) {
                            return;
                        }
                        root.then(Commands.literal("run").then(
                                Commands.literal(element.getFirst().toString()).executes(ctx -> {
                                    if(ctx.getSource().getEntity() instanceof ServerPlayer serverPlayer) {
                                        try {
                                            var start = System.nanoTime()/1000000.0;
                                            method.invoke(REntity.of(serverPlayer));
                                            var end = System.nanoTime()/1000000.0;
                                            ctx.getSource().sendSuccess(() -> Component.literal("Script execution took " + (end - start) + "ms"), true);
                                        } catch (Throwable e) {
                                            if(e instanceof WrongMethodTypeException) {
                                                ctx.getSource().sendFailure(Component.literal("Method " + element.getFirst() + " must take 1 parameter of type `entity`!"));
                                            } else {
                                                ExceptionPrinter.writeException(ctx.getSource().getPlayerOrException(), e);
                                            }
                                        }
                                    }
                                    return 0;
                                })
                        ));
                    } catch (Exception e) {
                        // if we got here, the method has parameters.
                        // just don't make it runnable in commands
                    }
                });
            } catch (Throwable _) {
                // ignore it here, since invoking $static_init failed :(
                // that means we just say no actions exist and move on with our lives
            }
        } catch (SpannedException e) {
            Main.handleError(e);
        }
    }

    public static void myStatsCommand(CommandDispatcher<CommandSourceStack> dispatcher, LiteralArgumentBuilder<CommandSourceStack> root) {
        root.then(Commands.literal("my_stats").executes(ctx -> {
            if(ctx.getSource().getEntity() instanceof ServerPlayer serverPlayer) {
                var stats = Resources.statManager().lookup(serverPlayer);
                ctx.getSource().sendSuccess(() -> Component.literal(stats.toString()), false);
            }
            return 0;
        }));
    }

    public static void setTagCommand(CommandDispatcher<CommandSourceStack> dispatcher, LiteralArgumentBuilder<CommandSourceStack> root) {
        root.then(
                Commands.literal("set_tag").then(
                        Commands.argument("key", StringArgumentType.string()).then(
                                Commands.argument("number", DoubleArgumentType.doubleArg()).executes(ctx -> {
                                    if(ctx.getSource().getEntity() instanceof ServerPlayer serverPlayer) {
                                        var itemInHand = serverPlayer.getItemBySlot(EquipmentSlot.MAINHAND);
                                        var rItem = RItem.of(itemInHand);
                                        RItem.set_tag(
                                                rItem,
                                                RString.of(ctx.getArgument("key", String.class)),
                                                RNumber.of(ctx.getArgument("number", Double.class))
                                        );
                                        RItem.update(rItem, RNullable.of(REntity.of(serverPlayer)));
                                        Resources.statManager().refreshPlayerInventories();
                                    }
                                    return 0;
                                })
                        ).then(
                                Commands.argument("string", StringArgumentType.string()).executes(ctx -> {
                                    if(ctx.getSource().getEntity() instanceof ServerPlayer serverPlayer) {
                                        var itemInHand = serverPlayer.getItemBySlot(EquipmentSlot.MAINHAND);
                                        var rItem = RItem.of(itemInHand);
                                        RItem.set_tag(
                                                rItem,
                                                RString.of(ctx.getArgument("key", String.class)),
                                                RString.of(ctx.getArgument("string", String.class))
                                        );
                                        RItem.update(rItem, RNullable.of(REntity.of(serverPlayer)));
                                        serverPlayer.setItemSlot(EquipmentSlot.MAINHAND, rItem.javaValue());
                                        Resources.statManager().refreshPlayerInventories();
                                    }
                                    return 0;
                                })
                        )
                )
        );
    }

    public static void register() {
        CommandRegistrationCallback.EVENT.register((dispatcher, _, _) -> {
            var root = Commands.literal("engine").requires(x -> x.hasPermission(4));

            for(var source : COMMAND_SOURCES) {
                source.accept(dispatcher, root);
            }

            dispatcher.register(root);
        });
    }
}
